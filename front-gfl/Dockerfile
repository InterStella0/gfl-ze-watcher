# Stage 1: Install dependencies
FROM oven/bun:alpine AS deps
WORKDIR /app
COPY package.json bun.lock ./
RUN bun ci

# Stage 2: Build the application
FROM oven/bun:alpine AS builder
WORKDIR /app

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules

# Copy application code
COPY . .

# Build-time environment variables
ARG BUILD_ENV=production
ARG DISCORD_CLIENT_ID=""
ARG NEXT_PUBLIC_DISCORD_REDIRECT_URI=""
ARG DISCORD_CLIENT_SECRET=""
ARG NEXT_PUBLIC_DOMAIN=""
ARG NEXTAUTH_SECRET=""
ARG STEAM_SECRET=""
ARG NEXTAUTH_URL=""
ARG FRONTEND_URL=""
ARG ANALYZE=""
ARG NEXT_PUBLIC_POSTHOG_KEY=""
ARG NEXT_PUBLIC_POSTHOG_HOST=""
ARG R2_PUBLIC_BASE_URL=""

# Create environment file for build
RUN cat <<EOF > .env.production
R2_PUBLIC_BASE_URL=${R2_PUBLIC_BASE_URL}
DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
NEXTAUTH_URL=${NEXTAUTH_URL}
DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}
NEXT_PUBLIC_DISCORD_REDIRECT_URI=${NEXT_PUBLIC_DISCORD_REDIRECT_URI}
NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
STEAM_SECRET=${STEAM_SECRET}
NEXT_PUBLIC_DOMAIN=${NEXT_PUBLIC_DOMAIN}
FRONTEND_URL=${FRONTEND_URL}
ANALYZE=${ANALYZE}
NEXT_PUBLIC_POSTHOG_KEY=${NEXT_PUBLIC_POSTHOG_KEY}
NEXT_PUBLIC_POSTHOG_HOST=${NEXT_PUBLIC_POSTHOG_HOST}
EOF

# Build the Next.js application with standalone output
RUN bun run build

# Stage 3: Production runner
FROM node:22-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production

# Runtime environment variables
ARG DISCORD_CLIENT_ID=""
ARG NEXT_PUBLIC_DISCORD_REDIRECT_URI=""
ARG DISCORD_CLIENT_SECRET=""
ARG NEXT_PUBLIC_DOMAIN=""
ARG NEXTAUTH_SECRET=""
ARG STEAM_SECRET=""
ARG NEXTAUTH_URL=""
ARG FRONTEND_URL=""
ARG NEXT_PUBLIC_POSTHOG_KEY=""
ARG NEXT_PUBLIC_POSTHOG_HOST=""
ARG R2_PUBLIC_BASE_URL=""

ENV DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
ENV R2_PUBLIC_BASE_URL=${R2_PUBLIC_BASE_URL}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ENV DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}
ENV NEXT_PUBLIC_DISCORD_REDIRECT_URI=${NEXT_PUBLIC_DISCORD_REDIRECT_URI}
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ENV STEAM_SECRET=${STEAM_SECRET}
ENV NEXT_PUBLIC_DOMAIN=${NEXT_PUBLIC_DOMAIN}
ENV FRONTEND_URL=${FRONTEND_URL}
ENV NEXT_PUBLIC_POSTHOG_KEY=${NEXT_PUBLIC_POSTHOG_KEY}
ENV NEXT_PUBLIC_POSTHOG_HOST=${NEXT_PUBLIC_POSTHOG_HOST}

# Copy standalone build output
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

CMD ["node", "server.js"]
